#!/bin/bash

# Função para verificar se o sistema é Debian ou Ubuntu
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        case "$ID" in
            debian)
                echo "O sistema é baseado no Debian."
                return 0
                ;;
            ubuntu)
                echo "O sistema é baseado no Ubuntu."
                return 0
                ;;
            *)
                echo "O sistema não é Debian nem Ubuntu. É baseado em: $ID."
                return 1
                ;;
        esac
    else
        echo "/etc/os-release não encontrado. Não é possível determinar a distribuição."
        return 1
    fi

# Função para analisar o código de retorno de um comando
check_return_code() {
    local return_code=$?
    local message=$1

    if [ $return_code -ne 0 ]; then
        echo "$(date '+%Y-%m-%d %H:%M:%S') Erro: $message (Código de retorno: $return_code)"
        exit $return_code
    else
        echo "$(date '+%Y-%m-%d %H:%M:%S') Sucesso: $message"
    fi
}

FASE="Adicionar a chave GPG do repositório do Trivy"
echo "$(date '+%Y-%m-%d %H:%M:%S') - $FASE"
Adicionar a chave GPG do repositório do Trivy
check_return_code "$FASE"

FASE="Adicionar o repositório do Trivy"
echo "$(date '+%Y-%m-%d %H:%M:%S') - $FASE"
echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee /etc/apt/sources.list.d/trivy.list
check_return_code "$FASE"

FASE="Atualizar os pacotes após adicionar o repositório"
echo "$(date '+%Y-%m-%d %H:%M:%S') - $FASE"
apt-get update
check_return_code "$FASE"

FASE="Instalar o Trivy"
echo "$(date '+%Y-%m-%d %H:%M:%S') - $FASE"
apt-get install -y trivy
check_return_code "$FASE"
